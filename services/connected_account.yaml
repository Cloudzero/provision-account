# -*- coding: utf-8 -*-
# Copyright (c) 2016-present, CloudZero, Inc. All rights reserved.
# Licensed under the BSD-style license. See LICENSE file in the project root for full license information.

AWSTemplateFormatVersion: '2010-09-09'
Description: CloudZero Connected Account Template

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Required
        Parameters:
          - AccountName
      - Label:
          default: CloudZero Cross Account Access
        Parameters:
          - ExternalId
    ParameterLabels:
      AccountName:
        default: |
          Descriptive Alias for your AWS Account; Generated by you; Used to ID your accounts in CloudZero platform
      ExternalId:
        default: |
          Unique ExternalId for your Organization; Generated by CloudZero; Used for Cross Account Roles

Parameters:
  AccountName:
    Type: String
    Default: ''
    Description: |
      Optional Name you can set for your AWS Account; you can use this as a
      descriptive alias for AccountId. It's useful to set this here when you
      are automating provisioning many accounts with this template.
  ExternalId:
    Type: String
    Description: |
      Unique ExternalId for Customer Organization; for cross-account Role Access and
      associating this template with a Customer Organization


Mappings:
  CallbackConfiguration:
    prod:
      # TODO: Get dynamically for namespaces
      ReactorAccountId: '061190967865'
      ReactorId: 'f7a07d02-d509-4e8d-9fb9-69c7985a6bd8'
      ReactorCallbackUrl: 'https://api.cloudzero.com/accounts/v1/link'

Conditions:
  ValidReactorCallbackUrl: !Not
    - !Equals [ !FindInMap [ CallbackConfiguration, prod, ReactorCallbackUrl ], 'null' ]

Resources:
  Discovery:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/latest/services/discovery.yaml

  # TODO: This Legacy Account supports older reactors that require all permissions in a single role
  LegacyAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      Parameters:
        IsResourceOwnerAccount: !GetAtt Discovery.Outputs.IsResourceOwnerAccount
        IsAuditAccount: !GetAtt Discovery.Outputs.IsAuditAccount
        IsMasterPayerAccount: !GetAtt Discovery.Outputs.IsMasterPayerAccount
        IsCloudTrailOwnerAccount: !GetAtt Discovery.Outputs.IsCloudTrailOwnerAccount
        ExternalId: !Ref ExternalId
        ReactorAccountId: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
        AuditCloudTrailBucketName: !GetAtt Discovery.Outputs.AuditCloudTrailBucketName
        MasterPayerBillingBucketName: !GetAtt Discovery.Outputs.MasterPayerBillingBucketName
        CloudTrailSQSQueueArn: !GetAtt CloudTrailOwnerAccount.Outputs.SQSQueueArn
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/latest/services/account_type/legacy.yaml


  ResourceOwnerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      Parameters:
        IsResourceOwnerAccount: !GetAtt Discovery.Outputs.IsResourceOwnerAccount
        ExternalId: !Ref ExternalId
        ReactorAccountId: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/latest/services/account_type/resource_owner.yaml

  CloudTrailOwnerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      Parameters:
        IsCloudTrailOwnerAccount: !GetAtt Discovery.Outputs.IsCloudTrailOwnerAccount
        CloudTrailSNSTopicArn: !GetAtt Discovery.Outputs.CloudTrailSNSTopicArn
        ReactorAccountId: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/latest/services/account_type/cloudtrail_owner.yaml

  AuditAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      Parameters:
        IsAuditAccount: !GetAtt Discovery.Outputs.IsAuditAccount
        AuditCloudTrailBucketName: !GetAtt Discovery.Outputs.AuditCloudTrailBucketName
        ExternalId: !Ref ExternalId
        ReactorAccountId: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/latest/services/account_type/audit.yaml

  MasterPayerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      Parameters:
        IsMasterPayerAccount: !GetAtt Discovery.Outputs.IsMasterPayerAccount
        MasterPayerBillingBucketName: !GetAtt Discovery.Outputs.MasterPayerBillingBucketName
        ExternalId: !Ref ExternalId
        ReactorAccountId: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/latest/services/account_type/master_payer.yaml


  NotificationFunctionStack:
    Type: AWS::CloudFormation::Stack
    Condition: ValidReactorCallbackUrl
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      Parameters:
        ReactorCallbackUrl: !FindInMap [ CallbackConfiguration, prod, ReactorCallbackUrl ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/latest/services/notification.yaml


  NotifyCloudZeroReactor:
    Type: Custom::NotifyCloudZero
    Condition: ValidReactorCallbackUrl    
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, prod, ReactorAccountId ]
      ServiceToken: !GetAtt NotificationFunctionStack.Outputs.Arn
      AccountId: !Ref AWS::AccountId
      Version: '1'
      # Parameters from Other Resources in this Stack
      ExternalId: !Ref ExternalId
      ReactorCallbackUrl: !FindInMap [ CallbackConfiguration, prod, ReactorCallbackUrl ]
      AccountName: !Ref AccountName
      Region: !Ref AWS::Region
      ReactorId: !FindInMap [ CallbackConfiguration, prod, ReactorId ]
      # References to other stacks; it's easier for _this_ Resource to simply grab the outputs
      # programmatically b/c some of the outputs are conditional.
      Stacks:
        Discovery: !Ref Discovery
        ResourceOwnerAccount: !Ref ResourceOwnerAccount
        CloudTrailOwnerAccount: !Ref CloudTrailOwnerAccount
        AuditAccount: !Ref AuditAccount
        MasterPayerAccount: !Ref MasterPayerAccount
        LegacyAccount: !Ref LegacyAccount



Outputs:
  BillingBucket:
    Value: !GetAtt Discovery.Outputs.MasterPayerBillingBucketName
  # BillingPrefix:
  #   Value: !GetAtt DiscoveryResource.MasterPayerBillingBucketPrefix
  CloudTrailArn:
    Value: !GetAtt Discovery.Outputs.CloudTrailTrailArn
  CloudTrailBucketPrefix:
    Value: !GetAtt Discovery.Outputs.AuditCloudTrailBucketPrefix
  CloudTrailBucket:
    Value: !GetAtt Discovery.Outputs.AuditCloudTrailBucketName
  ConnectedAccountId:
    Value: !Ref 'AWS::AccountId'
  ConnectedAccountName:
    Value: !Ref AccountName
  ExternalId:
    Value: !Ref ExternalId
  Region:
    Value: !Ref 'AWS::Region'
  RemoteCloudTrailBucket:
    Value: !GetAtt Discovery.Outputs.RemoteCloudTrailBucket
  RemoteCloudTrailId:
    Value: !Sub 'AccountId of the account that owns the ${Discovery.Outputs.AuditCloudTrailBucketName} bucket.'
  RemoteCloudTrailRole:
    Value: !Sub 'ClouZero RoleArn in the account that owns the ${Discovery.Outputs.AuditCloudTrailBucketName} bucket.'
  RoleArn:
    Value: !GetAtt LegacyAccount.Outputs.RoleArn
  SnsArn:
    Value: !GetAtt Discovery.Outputs.CloudTrailSNSTopicArn
  SqsArn:
    Value: !GetAtt CloudTrailOwnerAccount.Outputs.SQSQueueArn

