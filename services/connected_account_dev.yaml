# -*- coding: utf-8 -*-
# Copyright (c) 2016-present, CloudZero, Inc. All rights reserved.
# Licensed under the BSD-style license. See LICENSE file in the project root for full license information.

AWSTemplateFormatVersion: '2010-09-09'
Description: CloudZero Connected Account Template

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Required
        Parameters:
          - AccountName
      - Label:
          default: CloudZero Cross Account Access
        Parameters:
          - ExternalId
    ParameterLabels:
      AccountName:
        default: |
          Descriptive Alias for your AWS Account; Generated by you; Used to ID your accounts in CloudZero platform
      ExternalId:
        default: |
          Unique ExternalId for your Organization; Generated by CloudZero; Used for Cross Account Roles

Parameters:
  AccountName:
    Type: String
    Default: ''
    Description: |
      Optional Name you can set for your AWS Account; you can use this as a
      descriptive alias for AccountId. It's useful to set this here when you
      are automating provisioning many accounts with this template.
  ExternalId:
    Type: String
    Description: |
      Unique ExternalId for Customer Organization; for cross-account Role Access and
      associating this template with a Customer Organization

Mappings:
  CallbackConfiguration:
    dev:
      # TODO: Get dynamically for namespaces
      ReactorAccountId: '998146006915'
      ReactorId: '67ad3e83-1ec5-4f4f-b505-c27e2758b990'
      ReactorCallbackUrl: 'https://qc8rbx9mcg.execute-api.us-east-1.amazonaws.com/alfa/v1/link'

Conditions:
  ValidReactorCallbackUrl: !Not
    - !Equals [ !FindInMap [ CallbackConfiguration, dev, ReactorCallbackUrl ], 'null' ]

Resources:
  Discovery:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/v1.0.dev/services/discovery.yaml

  ResourceOwnerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      Parameters:
        IsResourceOwnerAccount: !GetAtt Discovery.Outputs.IsResourceOwnerAccount
        ExternalId: !Ref ExternalId
        ReactorAccountId: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/v1.0.dev/services/account_type/resource_owner.yaml

  CloudTrailOwnerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      Parameters:
        IsCloudTrailOwnerAccount: !GetAtt Discovery.Outputs.IsCloudTrailOwnerAccount
        CloudTrailSNSTopicArn: !GetAtt Discovery.Outputs.CloudTrailSNSTopicArn
        ReactorAccountId: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/v1.0.dev/services/account_type/cloudtrail_owner.yaml

  AuditAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      Parameters:
        IsAuditAccount: !GetAtt Discovery.Outputs.IsAuditAccount
        AuditCloudTrailBucketName: !GetAtt Discovery.Outputs.AuditCloudTrailBucketName
        ExternalId: !Ref ExternalId
        ReactorAccountId: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/v1.0.dev/services/account_type/audit.yaml

  MasterPayerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      Parameters:
        IsOrganizationMasterAccount: !GetAtt Discovery.Outputs.IsOrganizationMasterAccount
        IsMasterPayerAccount: !GetAtt Discovery.Outputs.IsMasterPayerAccount
        MasterPayerBillingBucketName: !GetAtt Discovery.Outputs.MasterPayerBillingBucketName
        ExternalId: !Ref ExternalId
        ReactorAccountId: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/v1.0.dev/services/account_type/master_payer.yaml


  NotificationFunctionStack:
    Type: AWS::CloudFormation::Stack
    Condition: ValidReactorCallbackUrl
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      Parameters:
        ReactorCallbackUrl: !FindInMap [ CallbackConfiguration, dev, ReactorCallbackUrl ]
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/v1.0.dev/services/notification.yaml


  NotifyCloudZeroReactor:
    Type: Custom::NotifyCloudZero
    Condition: ValidReactorCallbackUrl
    Properties:
      Tags:
        - Key: cloudzero-stack
          Value: !Ref AWS::StackName
        - Key: cloudzero-reactor-account-id
          Value: !FindInMap [ CallbackConfiguration, dev, ReactorAccountId ]
      ServiceToken: !GetAtt NotificationFunctionStack.Outputs.Arn
      AccountId: !Ref AWS::AccountId
      Version: '1'
      # Parameters from Other Resources in this Stack
      ExternalId: !Ref ExternalId
      ReactorCallbackUrl: !FindInMap [ CallbackConfiguration, dev, ReactorCallbackUrl ]
      AccountName: !Ref AccountName
      Region: !Ref AWS::Region
      ReactorId: !FindInMap [ CallbackConfiguration, dev, ReactorId ]
      # References to other stacks; it's easier for _this_ Resource to simply grab the outputs
      # programmatically b/c some of the outputs are conditional.
      Stacks:
        Discovery: !Ref Discovery
        ResourceOwnerAccount: !Ref ResourceOwnerAccount
        CloudTrailOwnerAccount: !Ref CloudTrailOwnerAccount
        AuditAccount: !Ref AuditAccount
        MasterPayerAccount: !Ref MasterPayerAccount
        LegacyAccount: !Ref ResourceOwnerAccount

Outputs:
  AuditAccount:
    Value: !Ref AuditAccount
  CloudTrailOwnerAccount:
    Value: !Ref CloudTrailOwnerAccount
  Discovery:
    Value: !Ref Discovery
  MasterPayerAccount:
    Value: !Ref MasterPayerAccount
  NotificationFunctionStack:
    Value: !If
      - ValidReactorCallbackUrl
      - !Ref NotificationFunctionStack
      - !Ref AWS::NoValue
  NotifyCloudZeroReactor:
    Value: !If
      - ValidReactorCallbackUrl
      - !Ref NotifyCloudZeroReactor
      - !Ref AWS::NoValue
  ResourceOwnerAccount:
    Value: !Ref ResourceOwnerAccount
