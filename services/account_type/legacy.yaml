# -*- coding: utf-8 -*-
# Copyright (c) 2016-present, CloudZero, Inc. All rights reserved.
# Licensed under the BSD-style license. See LICENSE file in the project root for full license information.

AWSTemplateFormatVersion: '2010-09-09'
Description: CloudZero Legacy Account Template

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: CloudZero Cross Account Access
        Parameters:
          - ExternalId
          - ReactorAccountId
          - IsResourceOwnerAccount
    ParameterLabels:
      ExternalId:
        default: |
          Unique ExternalId for your Organization; Generated by CloudZero; Used for Cross Account Roles
      ReactorAccountId:
        default: |
          CloudZero AWS AccountID; Used for Cross Account Roles
      IsResourceOwnerAccount:
        default: |
          Should this template create any resources?

Parameters:
  ExternalId:
    Type: String
    Description: |
      Unique ExternalId for Customer Organization; for cross-account Role Access and
      associating this template with a Customer Organization
  ReactorAccountId:
    Type: String
    Description: |
      CloudZero AWS AccountID; for cross-account Role Access
  IsResourceOwnerAccount:
    Type: String
    Description: |
      Should this template create Resource Owner Policy?
  IsAuditAccount:
    Type: String
    Description: |
      Should this template create Audit Policy?
  IsMasterPayerAccount:
    Type: String
    Description: |
      Should this template create MasterPayer Policy?
  IsCloudTrailOwnerAccount:
    Type: String
    Description: |
      Should this template create CloudTrail Owner Policy?
  AuditCloudTrailBucketName:
    Description: The name of the S3 bucket responsible for CloudTrail event data
    Type: String
  MasterPayerBillingBucketName:
    Description: The name of the S3 bucket responsible for billing data
    Type: String
  CloudTrailSQSQueueArn:
    Description: The CloudTrail Owner SQS Queue Arn
    Type: String


Conditions:
  CreateResources: !Equals [ !Ref IsResourceOwnerAccount, 'true' ]
  CreateCloudTrailPolicy: !And
    - !Equals [ !Ref IsCloudTrailOwnerAccount, 'true' ]
    - !Not [ !Equals [ !Ref CloudTrailSQSQueueArn, 'null' ] ]
  CreateMasterPayerPolicy: !And
    - !Equals [ !Ref IsMasterPayerAccount, 'true' ]
    - !Not [ !Equals [ !Ref MasterPayerBillingBucketName, 'null' ] ]
  CreateAuditPolicy: !And
    - !Equals [ !Ref IsAuditAccount, 'true' ]
    - !Not [ !Equals [ !Ref AuditCloudTrailBucketName, 'null' ] ]

Resources:
  Role:
    Type: AWS::IAM::Role
    Condition: CreateResources
    Properties:
      Path: '/cloudzero/'
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${ReactorAccountId}:root'
            Action:
              - 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/SecurityAudit
        - arn:aws:iam::aws:policy/AmazonSNSReadOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchEventsReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSXrayFullAccess
        - arn:aws:iam::aws:policy/AmazonGuardDutyReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonInspectorReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonRoute53ReadOnlyAccess

  RolePolicy:
    Type: AWS::IAM::Policy
    Condition: CreateResources
    Properties:
      PolicyName: !Sub 'cloudzero-resource-owner-policy-${ReactorAccountId}'
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          # CloudTrail Owner Account Permissions
          - !If
            - CreateCloudTrailPolicy
            - Sid: AccessCloudtrailQueue1
              Effect: Allow
              Action:
                - 'sqs:*'
              Resource:
                - !Ref CloudTrailSQSQueueArn
            - !Ref AWS::NoValue
          # Audit Account Permissions
          - !If
            - CreateAuditPolicy
            - Sid: AccessAuditCloudTrailBucket
              Effect: Allow
              Action:
                - 's3:Get*'
                - 's3:List*'
              Resource:
                - !Sub 'arn:aws:s3:::${AuditCloudTrailBucketName}'
                - !Sub 'arn:aws:s3:::${AuditCloudTrailBucketName}/*'
            - !Ref AWS::NoValue
          # Master Payer Account Permissions
          - !If
            - CreateMasterPayerPolicy
            - Sid: ProtectAccountInfo1
              Effect: Deny
              Action: 'aws-portal:*Account'
              Resource: '*'
            - !Ref AWS::NoValue
          - !If
            - CreateMasterPayerPolicy
            - Sid: AccessMasterPayerBillingBucket
              Effect: Allow
              Action:
                - 's3:Get*'
                - 's3:List*'
              Resource:
                - !Sub 'arn:aws:s3:::${MasterPayerBillingBucketName}'
                - !Sub 'arn:aws:s3:::${MasterPayerBillingBucketName}/*'
            - !Ref AWS::NoValue
          - !If
            - CreateMasterPayerPolicy
            - Sid: ViewBilling1
              Effect: Allow
              Action:
                - 'aws-portal:View*'
                - 'budgets:*'
                - 'cur:*'
                - 'ce:*'
              Resource: '*'
            - !Ref AWS::NoValue
          - !If
            - CreateMasterPayerPolicy
            - Sid: ReservedCapacityServices
              Effect: Allow
              Action:
                - 'cloudfront:Get*'
                - 'cloudfront:List*'
                - 'dynamodb:Describe*'
                - 'dynamodb:Get*'
                - 'dynamodb:List*'
                - 'ec2:Describe*'
                - 'ec2:Get*'
                - 'ec2:Get*'
                - 'elasticache:Describe*'
                - 'elasticache:List*'
                - 'elasticmapreduce:Describe*'
                - 'elasticmapreduce:List*'
                - 'es:Describe*'
                - 'es:List*'
                - 'es:Get*'
                - 'rds:Describe*'
                - 'redshift:Describe*'
                - 'redshift:List*'
              Resource: '*'
            - !Ref AWS::NoValue
          # Resource Owner Account Permissions
          - Sid: AccessCZLogGroups1
            Effect: Allow
            Action: logs:*
            Resource:
              - arn:aws:logs:*:*:log-group:/cz*:*:*
              - arn:aws:logs:*:*:log-group:/cz*
          - Sid: CreateVPCFlowLogs1
            Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:CreateLogGroup
              - logs:PutSubscriptionFilter
              - logs:PutRetentionPolicy
              - ec2:CreateFlowLogs
              - ec2:DescribeFlowLogs
            Resource: "*"
          - Sid: PassReactorRole1
            Effect: Allow
            Action:
              - iam:PassRole
            Resource: !GetAtt Role.Arn
          - Sid: ReducedViewOnly1
            Action:
              - apigateway:GET
              - apigateway:OPTIONS
              - apigateway:HEAD
              - athena:List*
              - batch:ListJobs
              - budgets:View*
              - cloudformation:List*
              - cloudformation:Get*
              - cloudformation:Describe*
              - cloudsearch:List*
              - cloudwatch:List*
              - cloudwatch:GetMetricData
              - codebuild:ListBuilds*
              - codestar:List*
              - codestar:Verify*
              - cognito-idp:List*
              - cognito-identity:ListIdentities
              - cognito-sync:ListDatasets
              - connect:List*
              - config:List*
              - datapipeline:GetAccountLimits
              - discovery:List*
              - dlm:Get*
              - dms:List*
              - dynamodb:List*
              - dynamodb:Describe*
              - ecr:List*
              - ec2:Get*
              - ec2:Describe*
              - es:Describe*
              - es:List*
              - elasticbeanstalk:List*
              - elasticfilesystem:Describe*
              - elasticmapreduce:List*
              - elastictranscoder:List*
              - events:ListRuleNamesByTarget
              - events:ListTargetsByRule
              - gamelift:List*
              - glacier:List*
              - health:*
              - importexport:List*
              - inspector:List*
              - iot:List*
              - iam:Get*
              - iam:List*
              - iam:Simulate*
              - lambda:List*
              - lambda:GetAccountSettings
              - lambda:GetAlias
              - lambda:GetEventSourceMapping
              - lambda:GetFunctionConfiguration
              - lambda:GetPolicy
              - machinelearning:Describe*
              - opsworks:Describe*
              - opsworks-cm:Describe*
              - organizations:List*
              - redshift:View*
              - redshift:Describe*
              - rds:List*
              - rds:Describe*
              - s3:List*
              - sagemaker:Describe*
              - sagemaker:List*
              - sdb:List*
              - servicecatalog:List*
              - ses:List*
              - shield:List*
              - states:ListActivities
              - states:ListStateMachines
              - sns:List*
              - sns:Get*
              - sqs:List*
              - sqs:Get*
              - ssm:ListAssociations
              - ssm:ListDocuments
              - swf:List*
              - trustedadvisor:Describe*
              - waf:List*
              - waf-regional:List*
            Effect: Allow
            Resource: "*"
      Roles:
        - !Ref Role

Outputs:
  RoleArn:
    Value: !If
      - CreateResources
      - !GetAtt Role.Arn
      - 'null'
    Description: Resource Owner Cross Account Role ARN
