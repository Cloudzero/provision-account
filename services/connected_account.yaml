# -*- coding: utf-8 -*-
# Copyright (c) 2016-present, CloudZero, Inc. All rights reserved.
# Licensed under the BSD-style license. See LICENSE file in the project root for full license information.

AWSTemplateFormatVersion: '2010-09-09'
Description: CloudZero Connected Account Template

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: CloudZero Cross Account Access
        Parameters:
          - ExternalId
          - ReactorAccountId
      - Label:
          default: CloudZero Callback Information
        Parameters:
          - ReactorSQSQueueUrl
    ParameterLabels:
      ExternalId:
        default: |
          Unique ExternalId for your Organization; Generated by CloudZero; Used for Cross Account Roles
      ReactorAccountId:
        default: |
          CloudZero AWS AccountID; Used for Cross Account Roles
      ReactorSQSQueueUrl:
        default: |
          CloudZero Reactor SQS Queue receives callbacks from this template

Parameters:
  ExternalId:
    Type: String
    Description: |
      Unique ExternalId for Customer Organization; for cross-account Role Access and
      associating this template with a Customer Organization
  ReactorAccountId:
    Type: String
    Default: 061190967865
    Description: |
      CloudZero AWS AccountID; for cross-account Role Access
  ReactorSQSQueueUrl:
    Type: String
    Default: Does not Exist Yet
    Description: |
      CloudZero Reactor Queue Url; receives callbacks from this template

Resources:
  Discovery:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero
          Value: cloudzero
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/services/latest/discovery.yaml

  ResourceOwnerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero
          Value: cloudzero
      Parameters:
        IsResourceOwnerAccount: !GetAtt Discovery.Outputs.IsConnectedAccount
        ExternalId: !Ref ExternalId
        ReactorAccountId: !Ref ReactorAccountId
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/services/latest/account_types/resource_owner.yaml

  CloudTrailOwnerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero
          Value: cloudzero
      Parameters:
        IsCloudTrailOwnerAccount: !GetAtt Discovery.Outputs.IsCloudTrailOwnerAccount
        CloudTrailSNSTopicName: !GetAtt Discovery.Outputs.CloudTrailSNSTopicName  # ARN?
        ExternalId: !Ref ExternalId
        ReactorAccountId: !Ref ReactorAccountId
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/services/latest/account_types/cloudtrail_owner.yaml

  AuditAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero
          Value: cloudzero
      Parameters:
        IsAuditAccount: !GetAtt Discovery.Outputs.IsAuditAccount
        AuditCloudTrailBucketName: !GetAtt Discovery.Outputs.AuditCloudTrailBucketName
        ExternalId: !Ref ExternalId
        ReactorAccountId: !Ref ReactorAccountId
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/services/latest/account_types/audit.yaml

  MasterPayerAccount:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero
          Value: cloudzero
      Parameters:
        IsAuditAccount: !GetAtt Discovery.Outputs.IsMasterPayerAccount
        MasterPayerBillingBucketName: !GetAtt Discovery.Outputs.MasterPayerBillingBucketName
        ExternalId: !Ref ExternalId
        ReactorAccountId: !Ref ReactorAccountId
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/services/latest/account_types/master_payer.yaml


  NotifyCloudZeroReactor:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: cloudzero
          Value: cloudzero
      Parameters:
        # Parameters
        ExternalId: !Ref ExternalId
        ReactorSQSQueueUrl: !Ref ReactorSQSQueueUrl
        # Discovery Output
        AuditCloudTrailBucketName: !GetAtt Discovery.Outputs.AuditCloudTrailBucketName
        CloudTrailSNSTopicName: !GetAtt Discovery.Outputs.CloudTrailSNSTopicName
        IsAuditAccount: !GetAtt Discovery.Outputs.IsAuditAccount
        IsMasterPayerAccount: !GetAtt Discovery.Outputs.IsMasterPayerAccount
        IsCloudTrailAccount: !GetAtt Discovery.Outputs.IsCloudTrailAccount
        IsConnectedAccount: !GetAtt Discovery.Outputs.IsConnectedAccount
        MasterPayerBillingBucketName: !GetAtt Discovery.Outputs.MasterPayerBillingBucketName
        # Account Types Output
        ResourceOwnerRoleArn: !GetAtt ResourceOwnerAccount.Outputs.RoleArn
        CloudTrailOwnerSQSQueueArn: !GetAtt CloudTrailOwnerAccount.Outputs.SQSQueueArn
        CloudTrailOwnerSQSQueuePolicyArn: !GetAtt CloudTrailOwnerAccount.Outputs.SQSQueuePolicyArn
        CloudTrailOwnerSNSTopicPolicyArn: !GetAtt CloudTrailOwnerAccount.Outputs.SNSTopicPolicyArn
        AuditRoleArn: !GetAtt AuditAccount.Outputs.RoleArn
        MasterPayerAccountRoleArn: !GetAtt MasterPayerAccount.Outputs.RoleArn
      TemplateURL: https://s3.amazonaws.com/cz-provision-account/services/latest/notify.yaml

Outputs:
  ResourceOwnerRoleArn:
    Value: !GetAtt ResourceOwnerAccount.Outputs.RoleArn
    Description: Resource Owner Cross Account Role ARN
  CloudTrailOwnerSQSQueueArn:
    Value: !GetAtt CloudTrailOwnerAccount.Outputs.SQSQueueArn
    Description: CloudTrail Owner SQS Queue Arn
  CloudTrailOwnerSQSQueuePolicyArn:
    Value: !GetAtt CloudTrailOwnerAccount.Outputs.SQSQueuePolicyArn
    Description: CloudTrail Owner SQS Queue Policy Arn
  CloudTrailOwnerSNSTopicPolicyArn:
    Value: !GetAtt CloudTrailOwnerAccount.Outputs.SNSTopicPolicyArn
    Description: CloudTrail Owner SNS Topic Policy Arn
  AuditRoleArn:
    Value: !GetAtt AuditAccount.Outputs.RoleArn
    Description: Audit Cross Account Role ARN
  MasterPayerAccountRoleArn:
    Value: !GetAtt MasterPayerAccount.Outputs.RoleArn
    Description: Master Payer Cross Account Role ARN
